<!DOCTYPE html>
<meta charset="utf-8">
<head>
    <title>A globe</title>
</head>
<style>

 #map {
     position: fixed;
     left: 0px;
     right: 0px;
     top: 0px;
     bottom: 0px;
 }

 div.tooltip {
     position: absolute;
     width: auto;
     height: auto;
     padding: 2px 3.5px;
     font-family: sans-serif;
     font-size: 11px;
     line-height: 1.5;
     border: 1px solid whitesmoke;
     border-radius: 3px;
     pointer-events: none;
 }

 .graticule {
     fill: none;
     stroke: white;
     stroke-width: 0.5px;
     stroke-opacity: 0.25;
 }

 .land {
     fill: whitesmoke;
     stroke: white;
     stroke-width: 0.5px;
 }

 .water {
     fill: lightgray;
 }

 .boundary {
     fill: none;
     stroke: #fff;
     stroke-width: 1px;
     stroke-opacity: 0.5;
 }

 .language {
     fill: black;
     opacity: 1;
 }

</style>
<body>
    <div id="map"></div>
    <script src="https://d3js.org/d3.v4.0.0-alpha.50.min.js"></script>
    <script src="https://d3js.org/d3-geo.v1.min.js"></script>
    <script src="https://d3js.org/d3-geo-projection.v2.min.js"></script>
    <script src="https://unpkg.com/topojson-client@3"></script>
    <script src="https://unpkg.com/d3-geo-voronoi"></script>
    <script src="http://d3js.org/queue.v1.min.js"></script>
    <script>

     var mapDiv = document.getElementById("map");
     var svg = d3.select("#map").append("svg");

     var width = mapDiv.clientWidth,
         height = mapDiv.clientHeight;

     var projection = d3.geoOrthographic()
                        .scale(Math.min(height / 2,
                                        width / 2))
                        .translate([width / 2, height / 2])
                        .rotate([-136,20])
                        .precision(0.1);

     var path = d3.geoPath()
                  .projection(projection);

     var graticule = d3.geoGraticule();

     var circle = d3.geoCircle();

     function circlePath(d) {
         return path(circle.center([d.longitude,d.latitude])
                   				 .radius(1.691667)());
     };

     var m0;
     var o0;

     var drag = d3.drag()
                  .on("start", function() {
                      var proj = projection.rotate();
                      m0 = [d3.event.sourceEvent.pageX,
                            d3.event.sourceEvent.pageY];
                      o0 = [-proj[0],-proj[1]];
                  })
                  .on("drag", function() {
                      if (m0) {
                          var m1 = [d3.event.sourceEvent.pageX,
                                    d3.event.sourceEvent.pageY],
                              o1 = [o0[0] + (m0[0] - m1[0]) / 4,
                                    o0[1] + (m1[1] - m0[1]) / 4];
                          projection.rotate([-o1[0], -o1[1]]);
                      }

                      // Update the map
                      svg.selectAll("path").attr("d", path);
                  })
                  .on("end", function() {
                      svg.selectAll(".dots path").attr("d", circlePath);
                  });

     svg.attr("width", width)
        .attr("height", height)
        .call(drag);

     /* svg.attr("viewBox","0 0 " + (height * 2) + " " + height)
      *    .attr("preserveAspectRatio", "xMidYMid meet");*/

     queue().defer(d3.json,"../../data/voronoi/ne_50m.json")
            .defer(d3.csv,"../../data/voronoi/all-points.csv")
            .await(plotmap);

     function plotmap(error, world, data){
         if (error) throw error;

         data.forEach(function (d) {
             d['longitude'] = +d['longitude'];
             d['latitude'] = +d['latitude'];
         });

         var div = d3.select("#map").append("div")
                     .attr("class","tooltip")
                     .style("opacity",0);

         var voronoi = d3.geoVoronoi()
                         .x(function(d) {return d.longitude;})
                         .y(function(d) {return d.latitude;})(data);

         svg.append("path")
            .datum(topojson.feature
                (world,world.objects.land))
            .attr("class","land")
            .attr("d",path);

         svg.append("g")
            .attr("class","polygons")
            .selectAll("clipPath")
            .data(voronoi.polygons().features)
            .enter()
            .append("clipPath")
            .attr("id", function(d, i) { return "clip-" + i; })
            .append("path")
            .attr("d",path);

         svg.append("g")
            .attr("class","dots")
            .selectAll("path")
            .data(data)
            .enter()
            .append("path")
            .attr("fill",function (d) {
                return d.color;
            })
            .attr("stroke",function (d) {
                return d.color;
            })
            .attr("stroke-width","0.5px")
            .attr("clip-path", function(d, i){
                return "url(#clip-" + i + ")"
            })
            .attr("d",circlePath);

         svg.append("path")
            .datum(topojson.feature(world, world.objects.oceans))
            .attr("class", "water")
            .attr("d", path);

         svg.append("path")
            .datum(topojson.feature(world, world.objects.lakes))
            .attr("class","water")
            .attr("d", path);

         svg.append("path")
            .datum(topojson.mesh(world, world.objects.countries,
                                 function(a, b) { return true; }))
            .attr("class", "boundary")
            .attr("d", path);

         svg.append("g")
            .attr("class","dots")
            .selectAll("path")
            .data(data)
            .enter()
            .append("path")
            .attr("id", function (d, i) {return "dot-" + i;})
            .attr("fill",function (d) {
                return d.color;
            })
            .attr("stroke",function (d) {
                return d.color;
            })
            .attr("stroke-width","0.5px")
            .attr("opacity",1/3)
            .attr("clip-path", function(d, i){
                return "url(#clip-" + i + ")"
            })
            .attr("d",circlePath);

         svg.append("path")
            .datum(graticule)
            .attr("class", "graticule")
            .attr("d", path);

         var globe_highlight = svg.append("defs").append("radialGradient")
                                  .attr("id", "globe_highlight")
                                  .attr("cx", "33.333%")
                                  .attr("cy", "33.333%");
         globe_highlight.append("stop")
                        .attr("offset", "5%")
                        .attr("stop-color", "white")
                        .attr("stop-opacity", 0);
         globe_highlight.append("stop")
                        .attr("offset", "100%")
                        .attr("stop-color", "darkgray")
                        .attr("stop-opacity", 1/6);

         var globe_shading = svg.append("defs").append("radialGradient")
                                .attr("id", "globe_shading")
                                .attr("cx", "50%")
                                .attr("cy", "40%");
         globe_shading.append("stop")
                      .attr("offset", "5%")
                      .attr("stop-color", "white")
                      .attr("stop-opacity", 0);
         globe_shading.append("stop")
                      .attr("offset", "100%")
                      .attr("stop-color", "black")
                      .attr("stop-opacity", 1/6);

         svg.append("circle")
            .attr("cx", width / 2)
            .attr("cy", height / 2)
            .attr("r", Math.min(width / 2, height / 2))
            .style("fill", "url(#globe_highlight)");

         svg.append("circle")
            .attr("cx", width / 2)
            .attr("cy", height / 2)
            .attr("r", Math.min(width / 2, height / 2))
            .style("fill", "url(#globe_shading)");

         svg.append("g")
            .attr("class","polygons")
            .selectAll("path")
            .data(voronoi.polygons().features)
            .enter()
            .append("path")
            .attr("d",path)
            .attr("opacity",0.001)
            .attr("stroke","none")
            .on("mouseover", function(d,i){
                div.transition()
                   .duration(200)
                   .style("opacity",.8);
                div.html("<b>" + data[i].name + "</b>")
                   .style("left",
                          (projection(
                              [data[i].longitude,
                               data[i].latitude])[0]+2) + "px")
                   .style("top",
                          (projection([data[i].longitude,
                                       data[i].latitude])[1]-11) + "px")
                   .style("background",data[i].color)
                   .style("color",
                          d3.lab(data[i].color).l > 70 ?
                          "black" : "white");
                d3.select("#dot-" + i)
                  .transition()
                  .duration(100)
                  .attr("opacity",1);
            })
            .on("click", function(d,i){
                if (div.active) {
                    div.html("<b>" + data[i].name + "</b>");
                    div.active = false;
                } else {
                    div.html("<b>" + data[i].name + "</b><br>"
                           + data[i].family + "<br>" + data[i].country);
                    div.active = true;
                };
            })
            .on("mouseout", function(d,i){
                div.transition()
                   .duration(500)
                   .style("opacity",0);
                d3.select("#dot-" + i)
                  .transition()
                  .duration(100)
                  .attr("opacity",1/3);
            });
     };
    </script>
</body>
